<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard | Queueless</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root{
            --primary:#6366f1;
            --success:#22c55e;
            --warning:#f59e0b;
            --danger:#ef4444;

            --bg:#0f172a;
            --card:rgba(255,255,255,.14);
            --border:rgba(255,255,255,.25);
            --text:#ffffff;
        }

        [data-theme="light"]{
            --bg:#f8fafc;
            --card:#ffffff;
            --border:#e5e7eb;
            --text:#111827;
        }

        *{
            margin:0;
            padding:0;
            box-sizing:border-box;
            font-family:Inter,sans-serif;
        }

        body{
            background:var(--bg);
            color:var(--text);
            display:flex;
            min-height:100vh;
        }

        /* SIDEBAR */
        .sidebar{
            width:260px;
            background:var(--card);
            backdrop-filter:blur(18px);
            border-right:1px solid var(--border);
            padding:24px;
        }

        .sidebar h2{margin-bottom:28px}

        .nav a{
            display:block;
            padding:12px 16px;
            border-radius:14px;
            margin-bottom:10px;
            text-decoration:none;
            color:inherit;
        }

        .nav a.active,
        .nav a:hover{
            background:rgba(99,102,241,.2);
        }

        /* MAIN */
        .main{flex:1;padding:24px}

        /* HEADER */
        .header{
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin-bottom:24px;
        }

        .toggle{
            cursor:pointer;
            padding:8px 14px;
            border-radius:999px;
            border:1px solid var(--border);
        }

        /* KPI */
        .kpis{
            display:grid;
            grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
            gap:18px;
            margin-bottom:24px;
        }

        .card{
            background:var(--card);
            border:1px solid var(--border);
            backdrop-filter:blur(16px);
            border-radius:22px;
            padding:22px;
        }

        .grid{
            display:grid;
            gap:24px;
        }

        @media(min-width:1000px){
            .grid{grid-template-columns:2fr 1fr;}
        }

        .progress{
            background:rgba(255,255,255,.2);
            height:12px;
            border-radius:999px;
            overflow:hidden;
            margin-top:8px;
        }
        .progress span{
            display:block;
            height:100%;
            background:linear-gradient(90deg,var(--primary),var(--success));
        }

        .health{
            display:grid;
            grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
            gap:12px;
        }

        .status{
            display:flex;
            align-items:center;
            gap:10px;
            font-weight:600;
        }

        .dot{
            width:10px;
            height:10px;
            border-radius:50%;
            background:var(--success);
            animation:pulse 1.5s infinite;
        }

        @keyframes pulse{
            0%{opacity:.5}
            50%{opacity:1}
            100%{opacity:.5}
        }

        .feed{
            max-height:280px;
            overflow:auto;
        }

        .feed-item{
            padding:12px 0;
            border-bottom:1px solid var(--border);
            font-size:.9rem;
        }

        .alert{
            padding:14px;
            border-radius:14px;
            margin-bottom:10px;
        }

        .alert.warn{background:rgba(245,158,11,.2)}
        .alert.danger{background:rgba(239,68,68,.2)}

        @media(max-width:768px){
            .sidebar{display:none}
        }
    </style>
</head>

<body>

<!-- SIDEBAR -->
<div class="sidebar">
    <h2>üöÄ Queueless</h2>
    <div class="nav">
        <a class="active">Dashboard</a>
        <a href="/customers.html">Customers</a>
        <a href="/analytics.html">Analytics</a>
        <a href="/billing.html">Billing</a>
        <a href="/settings.html">Settings</a>
    </div>
</div>

<!-- MAIN -->
<div class="main">

    <div class="header">
        <h2>üìä Admin Dashboard</h2>
        <div class="toggle" onclick="toggleTheme()">üåó Theme</div>
    </div>

    <div class="kpis">
        <div class="card">
            <small>Tokens Today</small>
            <h2 id="tokens">‚Äî</h2>
        </div>
        <div class="card">
            <small>Revenue</small>
            <h2 id="revenue">‚Äî</h2>
        </div>
        <div class="card">
            <small>Avg Bill</small>
            <h2 id="avgBill">‚Äî</h2>
        </div>
        <div class="card">
            <small>System Status</small>
            <h2 style="color:var(--success)">Operational</h2>
        </div>
    </div>

    <div class="grid">

        <div class="card">
            <h3>Usage Analytics</h3>
            <select onchange="loadChart(this.value)">
                <option value="week">This Week</option>
                <option value="month">This Month</option>
            </select>
            <canvas id="chart" height="140"></canvas>
        </div>

        <div class="card">
            <h3>Plan Usage</h3>
            <p>Plan: <b id="planName">‚Äî</b></p>
            <p>Tokens Used: <b id="used">‚Äî</b></p>
            <div class="progress">
                <span id="bar"></span>
            </div>

            <hr style="margin:18px 0;border-color:var(--border)">

            <h3>System Health</h3>
            <div class="health">
                <div class="status"><span class="dot"></span> API</div>
                <div class="status"><span class="dot"></span> Database</div>
                <div class="status"><span class="dot"></span> Payments</div>
            </div>
        </div>

    </div>

    <div class="grid" style="margin-top:24px">

        <div class="card">
            <h3>‚ö° Live Activity</h3>
            <div class="feed" id="feed"></div>
        </div>

        <div class="card">
            <h3>üö® Alerts</h3>
            <div class="alert warn">‚ö† Token usage nearing daily limit</div>
            <div class="alert danger">‚ùå Last payment retry failed</div>
        </div>

    </div>

</div>

<script>
    const API = "http://localhost:8080";
    const jwt = localStorage.getItem("jwt");

    if (!jwt) location.href = "/login.html";

    /* THEME */
    function toggleTheme(){
        const theme = document.documentElement.dataset.theme === "light" ? "dark" : "light";
        document.documentElement.dataset.theme = theme;
        localStorage.setItem("theme", theme);
    }
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "dark";

    /* üîí SUBSCRIPTION GATE */
    async function checkPlanAccess(){
        const res = await fetch(`${API}/api/admin/payments/current-subscription`, {
            headers:{ Authorization:"Bearer " + jwt }
        });

        if(!res.ok){
            location.href="/billing.html";
            return;
        }

        const sub = await res.json();
        const plan = sub.plan;

        if(plan !== "PRO" && plan !== "PRO_MAX"){
            location.href="/billing.html";
            return;
        }

        planName.innerText = plan;
    }

    /* DASHBOARD KPIs */
    async function loadDashboard(){
        const res = await fetch(`${API}/api/admin/analytics/today`, {
            headers:{ Authorization:"Bearer " + jwt }
        });

        const data = await res.json();

        tokens.innerText = data.totalTokensCompleted;
        revenue.innerText = "‚Çπ" + data.totalRevenue;
        avgBill.innerText = "‚Çπ" + data.averageBill;

        used.innerText = `${data.totalTokensCompleted} / ${data.planLimit}`;
        bar.style.width = Math.min(100, (data.totalTokensCompleted / data.planLimit) * 100) + "%";
    }

    /* CHART */
    let chart;
    function loadChart(type){
        const labels = type==="week"
            ? ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"]
            : Array.from({length:30},(_,i)=>i+1);

        const values = labels.map(()=>Math.floor(Math.random()*50)+10);

        if(chart) chart.destroy();
        chart = new Chart(document.getElementById("chart"),{
            type:"line",
            data:{
                labels,
                datasets:[{
                    data:values,
                    borderColor:"#6366f1",
                    backgroundColor:"rgba(99,102,241,.15)",
                    fill:true,
                    tension:.4
                }]
            },
            options:{ plugins:{ legend:{display:false} } }
        });
    }

    /* ACTIVITY */
    function loadFeed(){
        const events=[
            "New shop registered",
            "Payment captured successfully",
            "Queue completed in 3m 10s",
            "Token served",
            "Customer joined queue"
        ];
        feed.innerHTML="";
        events.forEach(e=>{
            feed.innerHTML+=`<div class="feed-item">‚Ä¢ ${e}</div>`;
        });
    }

    /* INIT */
    (async()=>{
        await checkPlanAccess();   // üîí HARD GATE
        await loadDashboard();
        loadChart("week");
        loadFeed();
    })();
</script>

</body>
</html>
